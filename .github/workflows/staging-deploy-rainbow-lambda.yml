name: "Staging - Deploy Rainbow Lambda"

on:
  push:
    branches: [main]
    paths-ignore:
      # Ignore all files and folders that start with '.'
      - ".**"
      # Ignore all files and folder in fixtures, tests, utils, etc.
      - "__*/**"
      - "tests/**"

env:
  AWS_ACCOUNT_ID: ${{ vars.STAGING_AWS_ACCOUNT_ID }}

permissions:
  id-token: write
  contents: read

jobs:
  deploy-form-viewer-service:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a # v4.3.1
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/platform-forms-client-apply
          role-session-name: ECSDeploy
          aws-region: ca-central-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1

      - name: Rainbow deployment
        uses: ./.github/workflows/rainbow-deployment
        with:
          deployment-identifier: ${{ github.sha }}
          latest-release-identifier: ${{ github.event.before }} #Â In Staging we use the commit ID to identify the version of the application that is currently deployed
          ecr-registry-uri: ${{ steps.login-ecr.outputs.registry }}
          ecr-registry-form-viewer-repository-name: form_viewer_staging
          cognito-app-client-id: ${{ secrets.STAGING_COGNITO_APP_CLIENT_ID }}
          cognito-user-pool-id: ${{ secrets.STAGING_COGNITO_USER_POOL_ID }}
          load-balancer-listener-arn: ${{ vars.STAGING_LOAD_BALANCER_LISTENER_ARN }}
          forms-lambda-client-role-arn: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/forms-lambda-client
          forms-lambda-client-subnet-ids: ${{ secrets.STAGING_FORMS_LAMBDA_CLIENT_SUBNET_IDS }}
          forms-lambda-client-security-group-ids: ${{ secrets.STAGING_FORMS_LAMBDA_CLIENT_SECURITY_GROUP_IDS }}
          hostname: forms-staging.cdssandbox.xyz

      - name: Logout of Amazon ECR
        if: always()
        run: docker logout ${{ steps.login-ecr.outputs.registry }}
